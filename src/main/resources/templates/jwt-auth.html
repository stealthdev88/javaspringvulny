<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
    <title th:text="${title}"></title>
    <th:block th:replace="general.html :: head"/>

    <style>
        #results {
            height: 150px;
            overflow: scroll;
        }
    </style>

</head>

<body>
<div class="container">
    <div th:insert="general.html :: header" class="header"></div>
    <div class="container">
        <h3>AJAX With JWT</h3>
        <div class="card mt-3">
            <div class="card-body">
                <div>JWT Token in Local Session: <pre id="jwt-token"></pre></div>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-body">
                <input id="search" type="text">
                <input class="btn btn-primary" type="button" id="items" value="Search">
                <pre id="results"></pre>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-body">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#basicExampleModal">Login</button>
                <button type="button" id="logout" class="btn btn-primary">Logout</button>
            </div>
        </div>
    </div>

    <!-- Button trigger modal -->
    <!-- Modal -->
    <div class="modal fade" id="basicExampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Log into JWT Rest API</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm">
                            <label for="username">Username:</label>
                        </div>
                        <div class="col-sm">
                            <input id="username" type="text" name="username"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm">
                            <label for="password">Password:</label>
                        </div>
                        <div class="col-sm">
                            <input id="password" type="password" name="password"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col" id="login-message-container"><pre id="login-message">&nbsp;</pre></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" id="login" class="btn btn-primary">Log In</button>
                </div>
            </div>
        </div>
    </div>

    <th:block th:replace="general.html :: scripts"/>
    <script lang="javascript">

        function showToken() {
            console.log('Showing jwt token');
            var jwt_token = localStorage.jwt_token;
            if (!jwt_token) {
                jwt_token = 'Not set';
            }
            $( "#jwt-token" ).text(jwt_token);
        }

        function resetResult(result) {
            result.text('')
                .removeClass('alert-success')
                .removeClass('alert-danger');
        }

        $(function() {

            showToken();

            $( "#items" ).click(function() {
                var searchText = $( "#search" ).val();
                resetResult($( 'result' ));
                $.ajax('/api/jwt/items/search/' + searchText, {
                    type: 'GET',
                    dataType: 'json',
                    beforeSend: function (xhr, settings) {
                        if (localStorage.jwt_token) {
                            console.log('Setting jwt token');
                            xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.jwt_token);
                        }
                    },
                    success: function(data) {
                        $( '#results' )
                            .text(JSON.stringify(data, undefined, 2))
                            .removeClass('alert-danger')
                            .addClass('alert-success');
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        console.log(xhr);
                        $( '#results' )
                            .text(JSON.stringify(xhr.responseJSON, undefined, 2))
                            .removeClass('alert-success')
                            .addClass('alert-danger');
                    }
                });
            });

            $( '#login' ).click(function() {
                var data = { 'username': $('#username').val(), 'password': $('#password').val()};

                resetResult($( 'login-message' ));

                $.ajax('/api/jwt/auth/signin', {
                    data: JSON.stringify(data),
                    contentType: 'application/json',
                    type: 'POST',
                    dataType: "json",
                    success: function(data, textStatus, xhr) {
                        localStorage.jwt_token = data.token;
                        console.log('Added token to local storage');
                        $( '#login-message' )
                            .text(xhr.status)
                            .removeClass('alert-danger')
                            .addClass('alert-success');
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        clearToken();
                        $( '#login-message' )
                            .text(xhr.status + ' ' + xhr.message)
                            .removeClass('alert-success')
                            .addClass('alert-danger');
                        console.log(xhr)
                    },
                    complete: function() {
                        showToken();
                    }
                });
            });

            function clearToken() {
                localStorage.clear();
                showToken();
                console.log('Cleared local storage');
            }

            $( '#logout' ).click(function() {
                clearToken();
            });

        });
    </script>
</div>
</body>
</html>